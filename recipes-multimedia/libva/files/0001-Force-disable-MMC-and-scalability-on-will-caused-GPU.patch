From ffb2ffaf40d3af3541cef7af93abc6a5f360d218 Mon Sep 17 00:00:00 2001
From: "Teng, Jin Chung" <jin.chung.teng@intel.com>
Date: Wed, 2 Mar 2022 12:07:06 +0800
Subject: [PATCH] Force disable MMC and scalability on will caused GPU Hang
 during multi channel decode.

Signed-off-by: Teng, Jin Chung <jin.chung.teng@intel.com>
---
 media_driver/linux/common/os/mos_os_specific.c    | 3 +++
 media_driver/linux/gen12/ddi/media_sku_wa_g12.cpp | 3 +++
 2 files changed, 6 insertions(+)

diff --git a/media_driver/linux/common/os/mos_os_specific.c b/media_driver/linux/common/os/mos_os_specific.c
index 49e5ffe..5e3d143 100644
--- a/media_driver/linux/common/os/mos_os_specific.c
+++ b/media_driver/linux/common/os/mos_os_specific.c
@@ -7330,6 +7330,9 @@ static MOS_STATUS Mos_Specific_InitInterface_Ve(
             osInterface->bHcpDecScalabilityMode = MOS_SCALABILITY_ENABLE_MODE_USER_FORCE;
         }
 
+	//WA: Force Scalability to turn off as it will caused GPU Hang
+        osInterface->bHcpDecScalabilityMode = MOS_SCALABILITY_ENABLE_MODE_FALSE;
+
 #if (_DEBUG || _RELEASE_INTERNAL)
         osInterface->frameSplit                  = false;
         MOS_ZeroMemory(&userFeatureData, sizeof(userFeatureData));
diff --git a/media_driver/linux/gen12/ddi/media_sku_wa_g12.cpp b/media_driver/linux/gen12/ddi/media_sku_wa_g12.cpp
index 88e0370..b2015ff 100644
--- a/media_driver/linux/gen12/ddi/media_sku_wa_g12.cpp
+++ b/media_driver/linux/gen12/ddi/media_sku_wa_g12.cpp
@@ -279,6 +279,9 @@ static bool InitTglMediaSku(struct GfxDeviceInfo *devInfo,
         MEDIA_WR_SKU(skuTable, FtrE2ECompression, 1);
     }
 
+    // WA: Force MMC turn off as it will cause GPU Hang during multi channel decode
+    MEDIA_WR_SKU(skuTable, FtrE2ECompression, 0);
+
     MEDIA_WR_SKU(skuTable, FtrLinearCCS, 1);
 
     MEDIA_WR_SKU(skuTable, FtrUseSwSwizzling, 1);
-- 
2.7.4

