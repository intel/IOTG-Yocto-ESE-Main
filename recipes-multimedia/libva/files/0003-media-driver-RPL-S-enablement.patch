From 918352c06641ebf07b82310df02218a304ff5556 Mon Sep 17 00:00:00 2001
From: "Mazlan, Hazwan Arif" <hazwan.arif.mazlan@intel.com>
Date: Thu, 24 Feb 2022 19:20:29 +0800
Subject: [PATCH 1/2] media-driver: RPL-S enablement

Signed-off-by: Mazlan, Hazwan Arif <hazwan.arif.mazlan@intel.com>
---
 .../cmake/linux/media_gen_flags_linux.cmake   |   8 ++
 .../linux/gen12/ddi/media_libva_caps_g12.cpp  |   5 +-
 .../linux/gen12/ddi/media_sku_wa_g12.cpp      |  49 +++++++++
 .../linux/gen12/ddi/media_sysinfo_g12.cpp     |  53 +++++++++
 .../media_interfaces_g12_rpls.cpp             | 102 ++++++++++++++++++
 .../media_interfaces_g12_rpls.h               |  42 ++++++++
 .../media_srcs.cmake                          |  49 +++++++++
 media_driver/media_interface/media_srcs.cmake |   4 +
 8 files changed, 311 insertions(+), 1 deletion(-)
 create mode 100644 media_driver/media_interface/media_interfaces_m12_rpls/media_interfaces_g12_rpls.cpp
 create mode 100644 media_driver/media_interface/media_interfaces_m12_rpls/media_interfaces_g12_rpls.h
 create mode 100644 media_driver/media_interface/media_interfaces_m12_rpls/media_srcs.cmake

diff --git a/media_driver/cmake/linux/media_gen_flags_linux.cmake b/media_driver/cmake/linux/media_gen_flags_linux.cmake
index b8f2562884c6..f7f879e2e94e 100644
--- a/media_driver/cmake/linux/media_gen_flags_linux.cmake
+++ b/media_driver/cmake/linux/media_gen_flags_linux.cmake
@@ -101,6 +101,10 @@ cmake_dependent_option(PVC
     "Enabled PVC support" ON
     "Xe_M;ENABLE_PRODUCTION_KMD" OFF)
 
+cmake_dependent_option(GEN12_RPLS
+    "Enabled RPLS support (Gen12)" ON
+    "GEN12_TGLLP" OFF)
+
 if(GEN8)
     add_definitions(-DIGFX_GEN8_SUPPORTED)
 endif()
@@ -192,6 +196,10 @@ if(GEN12_ADLN)
     add_definitions(-DIGFX_GEN12_ADLN_SUPPORTED)
 endif()
 
+if(GEN12_RPLS)
+       add_definitions(-DIGFX_GEN12_RPLS_SUPPORTED)
+endif()
+
 if(DG2)
     add_definitions(-DIGFX_DG2_SUPPORTED)
     add_definitions(-DIGFX_DG2_CMFCPATCH_SUPPORTED)
diff --git a/media_driver/linux/gen12/ddi/media_libva_caps_g12.cpp b/media_driver/linux/gen12/ddi/media_libva_caps_g12.cpp
index de6273089a4d..43eec166e8e6 100644
--- a/media_driver/linux/gen12/ddi/media_libva_caps_g12.cpp
+++ b/media_driver/linux/gen12/ddi/media_libva_caps_g12.cpp
@@ -2818,4 +2818,7 @@ static bool adlnRegistered = MediaLibvaCapsFactory<MediaLibvaCaps, DDI_MEDIA_CON
     RegisterCaps<MediaLibvaCapsG12>((uint32_t)IGFX_ALDERLAKE_N);
 #endif
 
-
+#ifdef IGFX_GEN12_RPLS_SUPPORTED
+static bool rplsRegistered = MediaLibvaCapsFactory<MediaLibvaCaps, DDI_MEDIA_CONTEXT>::
+    RegisterCaps<MediaLibvaCapsG12>((uint32_t)IGFX_RAPTORLAKE_S);
+#endif
diff --git a/media_driver/linux/gen12/ddi/media_sku_wa_g12.cpp b/media_driver/linux/gen12/ddi/media_sku_wa_g12.cpp
index 8155d885debc..d374af00ac9c 100644
--- a/media_driver/linux/gen12/ddi/media_sku_wa_g12.cpp
+++ b/media_driver/linux/gen12/ddi/media_sku_wa_g12.cpp
@@ -635,6 +635,55 @@ static bool adlnDeviceRegister = DeviceInfoFactory<LinuxDeviceInit>::
 
 #endif
 
+#ifdef IGFX_GEN12_RPLS_SUPPORTED
+static bool InitRplsMediaSku(struct GfxDeviceInfo *devInfo,
+                             MediaFeatureTable *skuTable,
+                             struct LinuxDriverInfo *drvInfo)
+{
+    if (!InitTglMediaSku(devInfo, skuTable, drvInfo))
+    {
+        return false;
+    }
+
+    if (devInfo->eGTType == GTTYPE_GT0_5)
+    {
+        MEDIA_WR_SKU(skuTable, FtrGT0_5, 1);
+    }
+
+    MEDIA_WR_SKU(skuTable, FtrAV1VLDLSTDecoding, 1);
+
+    //Disable VP8 for RPLS
+    MEDIA_WR_SKU(skuTable, FtrIntelVP8VLDDecoding, 0);
+
+    return true;
+}
+
+static bool InitRplsMediaWa(struct GfxDeviceInfo* devInfo,
+                            MediaWaTable* waTable,
+                            struct LinuxDriverInfo* drvInfo)
+{
+    if (!InitTglMediaWa(devInfo, waTable, drvInfo))
+    {
+        return false;
+    }
+
+    //RPL-S not need this
+    MEDIA_WR_WA(waTable, Wa_1409820462, 0);
+
+    return true;
+}
+
+static struct LinuxDeviceInit rplsDeviceInit =
+{
+    .productFamily    = IGFX_RAPTORLAKE_S,
+    .InitMediaFeature = InitRplsMediaSku,
+    .InitMediaWa = InitRplsMediaWa,
+};
+
+static bool rplsDeviceRegister = DeviceInfoFactory<LinuxDeviceInit>::
+    RegisterDevice(IGFX_RAPTORLAKE_S, &rplsDeviceInit);
+#endif
+
 static struct LinuxDeviceInit tgllpDeviceInit =
 {
     .productFamily    = IGFX_TIGERLAKE_LP,
diff --git a/media_driver/linux/gen12/ddi/media_sysinfo_g12.cpp b/media_driver/linux/gen12/ddi/media_sysinfo_g12.cpp
index f68fe66658ad..3e568bf17292 100644
--- a/media_driver/linux/gen12/ddi/media_sysinfo_g12.cpp
+++ b/media_driver/linux/gen12/ddi/media_sysinfo_g12.cpp
@@ -491,6 +491,59 @@ static bool adlnGt1Device46D2 = DeviceInfoFactory<GfxDeviceInfo>::
     RegisterDevice(0x46D2, &adlnGt1Info);
 #endif 
 
+#ifdef IGFX_GEN12_RPLS_SUPPORTED
+static struct GfxDeviceInfo rplsGt1Info = {
+    .platformType     = PLATFORM_DESKTOP,
+    .productFamily    = IGFX_RAPTORLAKE_S,
+    .displayFamily    = IGFX_GEN12_CORE,
+    .renderFamily     = IGFX_GEN12_CORE,
+    .eGTType          = GTTYPE_GT1,
+    .L3CacheSizeInKb  = 0,
+    .L3BankCount      = 0,
+    .EUCount          = 0,
+    .SliceCount       = 0,
+    .SubSliceCount    = 0,
+    .MaxEuPerSubSlice = 0,
+    .isLCIA           = 0,
+    .hasLLC           = 0,
+    .hasERAM          = 0,
+    .InitMediaSysInfo = InitTglMediaSysInfo,
+    .InitShadowSku    = InitTglShadowSku,
+    .InitShadowWa     = InitTglShadowWa,
+};
+
+static struct GfxDeviceInfo rplsGt1fInfo = {
+    .platformType     = PLATFORM_DESKTOP,
+    .productFamily    = IGFX_RAPTORLAKE_S,
+    .displayFamily    = IGFX_GEN12_CORE,
+    .renderFamily     = IGFX_GEN12_CORE,
+    .eGTType          = GTTYPE_GT0_5,
+    .L3CacheSizeInKb  = 0,
+    .L3BankCount      = 0,
+    .EUCount          = 0,
+    .SliceCount       = 0,
+    .SubSliceCount    = 0,
+    .MaxEuPerSubSlice = 0,
+    .isLCIA           = 0,
+    .hasLLC           = 0,
+    .hasERAM          = 0,
+    .InitMediaSysInfo = InitTglMediaSysInfo,
+    .InitShadowSku    = InitTglShadowSku,
+    .InitShadowWa     = InitTglShadowWa,
+};
+
+static bool rplsGt1DeviceA780 = DeviceInfoFactory<GfxDeviceInfo>::
+    RegisterDevice(0xA780, &rplsGt1Info);
+
+static bool rplsGt1DeviceA781 = DeviceInfoFactory<GfxDeviceInfo>::
+    RegisterDevice(0xA781, &rplsGt1Info);
+
+static bool rplsGt1DeviceA782 = DeviceInfoFactory<GfxDeviceInfo>::
+    RegisterDevice(0xA782, &rplsGt1Info);
+
+static bool rplsGt1DeviceA783 = DeviceInfoFactory<GfxDeviceInfo>::
+    RegisterDevice(0xA783, &rplsGt1fInfo);
+#endif
 
 static bool tgllpGt2Device9a40 = DeviceInfoFactory<GfxDeviceInfo>::
     RegisterDevice(0x9A40, &tgllpGt2Info);
diff --git a/media_driver/media_interface/media_interfaces_m12_rpls/media_interfaces_g12_rpls.cpp b/media_driver/media_interface/media_interfaces_m12_rpls/media_interfaces_g12_rpls.cpp
new file mode 100644
index 000000000000..08402eaa7341
--- /dev/null
+++ b/media_driver/media_interface/media_interfaces_m12_rpls/media_interfaces_g12_rpls.cpp
@@ -0,0 +1,102 @@
+/*
+* Copyright (c) 2011-2020, Intel Corporation
+*
+* Permission is hereby granted, free of charge, to any person obtaining a
+* copy of this software and associated documentation files (the "Software"),
+* to deal in the Software without restriction, including without limitation
+* the rights to use, copy, modify, merge, publish, distribute, sublicense,
+* and/or sell copies of the Software, and to permit persons to whom the
+* Software is furnished to do so, subject to the following conditions:
+*
+* The above copyright notice and this permission notice shall be included
+* in all copies or substantial portions of the Software.
+*
+* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
+* OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
+* FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL
+* THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR
+* OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
+* ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
+* OTHER DEALINGS IN THE SOFTWARE.
+*/
+//!
+//! \file     media_interfaces_g12_rpls.cpp
+//! \brief    Helps with Gen12 RPLS factory creation.
+//!
+
+#include "media_interfaces_g12_rpls.h"
+
+extern template class MediaInterfacesFactory<MhwInterfaces>;
+extern template class MediaInterfacesFactory<MmdDevice>;
+extern template class MediaInterfacesFactory<MosUtilDevice>;
+extern template class MediaInterfacesFactory<CodechalDevice>;
+extern template class MediaInterfacesFactory<CMHalDevice>;
+extern template class MediaInterfacesFactory<VphalDevice>;
+extern template class MediaInterfacesFactory<RenderHalDevice>;
+extern template class MediaInterfacesFactory<Nv12ToP010Device>;
+extern template class MediaInterfacesFactory<DecodeHistogramDevice>;
+
+static bool rplsRegisteredVphal =
+    MediaInterfacesFactory<VphalDevice>::
+    RegisterHal<VphalInterfacesG12Tgllp>((uint32_t)IGFX_RAPTORLAKE_S);
+
+static bool rplsRegisteredMhw =
+    MediaInterfacesFactory<MhwInterfaces>::
+    RegisterHal<MhwInterfacesG12Tgllp>((uint32_t)IGFX_RAPTORLAKE_S);
+
+#ifdef _MMC_SUPPORTED
+static bool rplsRegisteredMmd =
+    MediaInterfacesFactory<MmdDevice>::
+        RegisterHal<MmdDeviceG12Tgllp>((uint32_t)IGFX_RAPTORLAKE_S);
+#endif
+
+static bool rplsRegisteredNv12ToP010 =
+    MediaInterfacesFactory<Nv12ToP010Device>::
+    RegisterHal<Nv12ToP010DeviceG12Tgllp>((uint32_t)IGFX_RAPTORLAKE_S);
+
+static bool rplsRegisteredCodecHal =
+    MediaInterfacesFactory<CodechalDevice>::
+    RegisterHal<CodechalInterfacesG12Tgllp>((uint32_t)IGFX_RAPTORLAKE_S);
+
+static bool rplsRegisteredCMHal =
+    MediaInterfacesFactory<CMHalDevice>::
+    RegisterHal<CMHalInterfacesG12Rpls>((uint32_t)IGFX_RAPTORLAKE_S);
+
+static bool rplsRegisteredMosUtil =
+    MediaInterfacesFactory<MosUtilDevice>::
+    RegisterHal<MosUtilDeviceG12Tgllp>((uint32_t)IGFX_RAPTORLAKE_S);
+
+static bool rplsRegisteredRenderHal =
+    MediaInterfacesFactory<RenderHalDevice>::
+    RegisterHal<RenderHalInterfacesG12Tgllp>((uint32_t)IGFX_RAPTORLAKE_S);
+
+static bool rplsRegisteredDecodeHistogram =
+    MediaInterfacesFactory<DecodeHistogramDevice>::
+    RegisterHal<DecodeHistogramDeviceG12Tgllp>((uint32_t)IGFX_RAPTORLAKE_S);
+
+#define PLATFORM_INTEL_RPLS 25
+#define GENX_TGLLP 12
+
+MOS_STATUS CMHalInterfacesG12Rpls::Initialize(CM_HAL_STATE *pCmState)
+{
+    if (pCmState == nullptr)
+    {
+        MHW_ASSERTMESSAGE("pCmState is nullptr.")
+        return MOS_STATUS_INVALID_PARAMETER;
+    }
+
+    m_cmhalDevice = MOS_New(CMHal, pCmState);
+    if (m_cmhalDevice == nullptr)
+    {
+        MHW_ASSERTMESSAGE("Create CM Hal interfaces failed.")
+        return MOS_STATUS_NO_SPACE;
+    }
+
+    m_cmhalDevice->SetGenPlatformInfo(PLATFORM_INTEL_RPLS, PLATFORM_INTEL_GT2, "TGLLP");
+    uint32_t cisaIDs[] = {GENX_TGLLP};
+    m_cmhalDevice->AddSupportedCisaIDs(cisaIDs, sizeof(cisaIDs) / sizeof(uint32_t));
+    m_cmhalDevice->m_l3Plane       = TGL_L3_PLANE;
+    m_cmhalDevice->m_l3ConfigCount = TGL_L3_CONFIG_NUM;
+    return MOS_STATUS_SUCCESS;
+}
+
diff --git a/media_driver/media_interface/media_interfaces_m12_rpls/media_interfaces_g12_rpls.h b/media_driver/media_interface/media_interfaces_m12_rpls/media_interfaces_g12_rpls.h
new file mode 100644
index 000000000000..b3b206271b78
--- /dev/null
+++ b/media_driver/media_interface/media_interfaces_m12_rpls/media_interfaces_g12_rpls.h
@@ -0,0 +1,42 @@
+/*
+* Copyright (c) 2011-2021, Intel Corporation
+*
+* Permission is hereby granted, free of charge, to any person obtaining a
+* copy of this software and associated documentation files (the "Software"),
+* to deal in the Software without restriction, including without limitation
+* the rights to use, copy, modify, merge, publish, distribute, sublicense,
+* and/or sell copies of the Software, and to permit persons to whom the
+* Software is furnished to do so, subject to the following conditions:
+*
+* The above copyright notice and this permission notice shall be included
+* in all copies or substantial portions of the Software.
+*
+* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
+* OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
+* FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL
+* THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR
+* OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
+* ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
+* OTHER DEALINGS IN THE SOFTWARE.
+*/
+
+//!
+//! \file     media_interfaces_g12_rpls.h
+//! \brief    All interfaces used for rpls that require factory creation
+//!
+
+#ifndef __MEDIA_INTERFACES_G12_rpls_H__
+#define __MEDIA_INTERFACES_G12_rpls_H__
+
+#include "media_interfaces_g12_tgllp.h"
+#include "renderhal_g12_base.h"
+
+class CMHalInterfacesG12Rpls : public CMHalDevice
+{
+protected:
+    using CMHal = CM_HAL_G12_X;
+    MOS_STATUS Initialize(
+        CM_HAL_STATE *pCmState);
+};
+
+#endif // __MEDIA_INTERFACES_G12_rpls_H__
diff --git a/media_driver/media_interface/media_interfaces_m12_rpls/media_srcs.cmake b/media_driver/media_interface/media_interfaces_m12_rpls/media_srcs.cmake
new file mode 100644
index 000000000000..4b686e479a5c
--- /dev/null
+++ b/media_driver/media_interface/media_interfaces_m12_rpls/media_srcs.cmake
@@ -0,0 +1,49 @@
+# Copyright (c) 2020, Intel Corporation
+#
+# Permission is hereby granted, free of charge, to any person obtaining a
+# copy of this software and associated documentation files (the "Software"),
+# to deal in the Software without restriction, including without limitation
+# the rights to use, copy, modify, merge, publish, distribute, sublicense,
+# and/or sell copies of the Software, and to permit persons to whom the
+# Software is furnished to do so, subject to the following conditions:
+#
+# The above copyright notice and this permission notice shall be included
+# in all copies or substantial portions of the Software.
+#
+# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
+# OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
+# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL
+# THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR
+# OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
+# ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
+# OTHER DEALINGS IN THE SOFTWARE.
+
+set(TMP_SOURCES_
+    ${CMAKE_CURRENT_LIST_DIR}/media_interfaces_g12_rpls.cpp
+)
+
+set(TMP_HEADERS_
+    ${CMAKE_CURRENT_LIST_DIR}/media_interfaces_g12_rpls.h
+)
+
+set(SOURCES_
+    ${SOURCES_}
+    ${TMP_SOURCES_}
+)
+
+set(HEADERS_
+    ${HEADERS_}
+    ${TMP_HEADERS_}
+)
+
+set(COMMON_SOURCES_
+    ${COMMON_SOURCES_}
+    ${TMP_SOURCES_}
+)
+
+set(COMMON_HEADERS_
+    ${COMMON_HEADERS_}
+    ${TMP_HEADERS_}
+)
+
+media_add_curr_to_include_path()
diff --git a/media_driver/media_interface/media_srcs.cmake b/media_driver/media_interface/media_srcs.cmake
index dfa7aa3f1c28..c2788815e4bc 100644
--- a/media_driver/media_interface/media_srcs.cmake
+++ b/media_driver/media_interface/media_srcs.cmake
@@ -79,6 +79,10 @@ if(GEN12_ADLN)
     media_include_subdirectory(media_interfaces_m12_adln)
 endif()
 
+if(GEN12_RPLS)
+    media_include_subdirectory(media_interfaces_m12_rpls)
+endif()
+
 if(XEHP_SDV)
     media_include_subdirectory(media_interfaces_xehp_sdv)
 endif()
-- 
2.34.1

