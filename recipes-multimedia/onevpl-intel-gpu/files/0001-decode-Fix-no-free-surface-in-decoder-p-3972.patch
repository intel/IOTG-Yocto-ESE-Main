From 7e9c2893f134a55f1315fba5cfb6053c127f1acb Mon Sep 17 00:00:00 2001
From: gfxVPLsdm <gfxvplsdm@intel.com>
Date: Mon, 28 Nov 2022 15:41:00 +0800
Subject: [PATCH 1/3] [decode] Fix no free surface in decoder p (#3972)

Co-authored-by: Ch'ng, Seng Guan <seng.guan.chng@intel.com>
---
 .../codec/h264_dec/include/umc_h264_task_supplier.h |  2 +-
 .../codec/h264_dec/src/umc_h264_task_supplier.cpp   | 13 +++++++++++++
 2 files changed, 14 insertions(+), 1 deletion(-)

diff --git a/_studio/shared/umc/codec/h264_dec/include/umc_h264_task_supplier.h b/_studio/shared/umc/codec/h264_dec/include/umc_h264_task_supplier.h
index d2f1afec..1f4a99d6 100644
--- a/_studio/shared/umc/codec/h264_dec/include/umc_h264_task_supplier.h
+++ b/_studio/shared/umc/codec/h264_dec/include/umc_h264_task_supplier.h
@@ -427,7 +427,7 @@ public:
     Status UpdateRefPicMarking(ViewItem &view, H264DecoderFrame * pFrame, H264Slice * pSlice, int32_t field_index);
 
     void SlideWindow(ViewItem &view, H264Slice * pSlice, int32_t field_index);
-
+    void ResetUnusedFrames(ViewItem &view);
     void Reset();
 
     void CheckSEIRepetition(ViewItem &view, H264DecoderFrame * frame);
diff --git a/_studio/shared/umc/codec/h264_dec/src/umc_h264_task_supplier.cpp b/_studio/shared/umc/codec/h264_dec/src/umc_h264_task_supplier.cpp
index 90493daa..d49267fb 100644
--- a/_studio/shared/umc/codec/h264_dec/src/umc_h264_task_supplier.cpp
+++ b/_studio/shared/umc/codec/h264_dec/src/umc_h264_task_supplier.cpp
@@ -836,6 +836,18 @@ Status DecReferencePictureMarking::UpdateRefPicMarking(ViewItem &view, H264Decod
     return umcRes;
 }
 
+void DecReferencePictureMarking::ResetUnusedFrames(ViewItem &view)
+{
+    for (H264DecoderFrame *pTmp = view.GetDPBList(0)->head(); pTmp; pTmp = pTmp->future())
+    {
+        if(!pTmp->isShortTermRef() && !pTmp->isLongTermRef() && pTmp->GetRefCounter() == 0 &&
+            pTmp->m_wasOutputted && pTmp->m_wasDisplayed)
+        {
+            pTmp->Reset();
+        }
+    }
+}
+
 /****************************************************************************************************/
 //
 /****************************************************************************************************/
@@ -4094,6 +4106,7 @@ void TaskSupplier::DBPUpdate(H264DecoderFrame * pFrame, int32_t field)
         ViewItem &view = GetView(slice->GetSliceHeader()->nal_ext.mvc.view_id);
 
         DecReferencePictureMarking::UpdateRefPicMarking(view, pFrame, slice, field);
+        DecReferencePictureMarking::ResetUnusedFrames(view);
         break;
     }
 }
-- 
2.30.2

