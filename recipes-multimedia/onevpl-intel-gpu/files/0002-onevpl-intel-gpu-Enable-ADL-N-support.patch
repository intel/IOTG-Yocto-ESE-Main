From c6fb611748d5d33538c3f859eb71d9474e908462 Mon Sep 17 00:00:00 2001
From: "Yew, Chang Ching" <chang.ching.yew@intel.com>
Date: Thu, 27 Jan 2022 18:03:24 +0800
Subject: [PATCH 2/3] onevpl-intel-gpu: Enable ADL-N support

[Internal]
Issue: VSMGWL-43147

HSDES ID: NA

Signed-off-by: Lim Siew Hoon <siew.hoon.lim@intel.com>
---
 .../cmrt_cross_platform/include/cmrt_cross_platform.h        | 1 +
 .../mfx_lib/encode_hw/h264/src/mfx_h264_enc_common_hw.cpp    | 2 +-
 _studio/mfx_lib/ext/h264/src/mfx_h264_encode_cm.cpp          | 1 +
 _studio/mfx_lib/shared/src/mfx_common_int.cpp                | 1 +
 _studio/mfx_lib/vpp/src/mfx_vpp_hw.cpp                       | 3 ++-
 _studio/shared/asc/src/asc.cpp                               | 1 +
 _studio/shared/include/mfxstructures-int.h                   | 5 +++++
 _studio/shared/src/cm_mem_copy.cpp                           | 1 +
 api/vpl/mfxcommon.h                                          | 1 +
 9 files changed, 14 insertions(+), 2 deletions(-)

diff --git a/_studio/mfx_lib/cmrt_cross_platform/include/cmrt_cross_platform.h b/_studio/mfx_lib/cmrt_cross_platform/include/cmrt_cross_platform.h
index 1846829da156..d89821127305 100644
--- a/_studio/mfx_lib/cmrt_cross_platform/include/cmrt_cross_platform.h
+++ b/_studio/mfx_lib/cmrt_cross_platform/include/cmrt_cross_platform.h
@@ -717,6 +717,7 @@ typedef enum _GPU_PLATFORM {
     PLATFORM_INTEL_ADL_S = 21,  //AlderLake
     PLATFORM_INTEL_DG2 = 22,  //DG2
     PLATFORM_INTEL_ADL_P = 23, //AlderLake
+    PLATFORM_INTEL_ADL_N = 24, //AlderLake
     PLATFORM_INTEL_RPL_S = 25, //RaptorLake
 } GPU_PLATFORM;
 
diff --git a/_studio/mfx_lib/encode_hw/h264/src/mfx_h264_enc_common_hw.cpp b/_studio/mfx_lib/encode_hw/h264/src/mfx_h264_enc_common_hw.cpp
index a4c19f3e8e7d..1b21b2af0599 100644
--- a/_studio/mfx_lib/encode_hw/h264/src/mfx_h264_enc_common_hw.cpp
+++ b/_studio/mfx_lib/encode_hw/h264/src/mfx_h264_enc_common_hw.cpp
@@ -1328,7 +1328,7 @@ bool MfxHwH264Encode::IsExtBrcSceneChangeSupported(
 bool MfxHwH264Encode::IsCmSupported(eMFXHWType platform)
 {
     return
-        (platform <= MFX_HW_ADL_P);
+        (platform == MFX_HW_ADL_N) || (platform <= MFX_HW_ADL_P);
 }
 
 bool MfxHwH264Encode::IsCmNeededForSCD(
diff --git a/_studio/mfx_lib/ext/h264/src/mfx_h264_encode_cm.cpp b/_studio/mfx_lib/ext/h264/src/mfx_h264_encode_cm.cpp
index 6bc50916f15b..92f9b0889b52 100644
--- a/_studio/mfx_lib/ext/h264/src/mfx_h264_encode_cm.cpp
+++ b/_studio/mfx_lib/ext/h264/src/mfx_h264_encode_cm.cpp
@@ -860,6 +860,7 @@ void CmContext::Setup(
     case MFX_HW_RKL:
     case MFX_HW_ADL_S:
     case MFX_HW_ADL_P:
+    case MFX_HW_ADL_N:
     case MFX_HW_RPL_S:
         m_program = ReadProgram(m_device, genx_simple_me_gen12lp, SizeOf(genx_simple_me_gen12lp));
         m_programHist = ReadProgram(m_device, genx_histogram_gen12lp, SizeOf(genx_histogram_gen12lp));
diff --git a/_studio/mfx_lib/shared/src/mfx_common_int.cpp b/_studio/mfx_lib/shared/src/mfx_common_int.cpp
index 18f32bf60159..a5aeb3f2c670 100644
--- a/_studio/mfx_lib/shared/src/mfx_common_int.cpp
+++ b/_studio/mfx_lib/shared/src/mfx_common_int.cpp
@@ -1195,6 +1195,7 @@ mfxPlatform MakePlatform(eMFXHWType type, mfxU16 device_id)
                          platform.CodeName = MFX_PLATFORM_TIGERLAKE;     break;
     case MFX_HW_ADL_S  : platform.CodeName = MFX_PLATFORM_ALDERLAKE_S;   break;
     case MFX_HW_ADL_P  : platform.CodeName = MFX_PLATFORM_ALDERLAKE_P;   break;
+    case MFX_HW_ADL_N  : platform.CodeName = MFX_PLATFORM_ALDERLAKE_N;   break;
     case MFX_HW_RPL_S  : platform.CodeName = MFX_PLATFORM_RAPTORLAKE_S;   break;
     case MFX_HW_DG2    :
                          platform.MediaAdapterType = MFX_MEDIA_DISCRETE;
diff --git a/_studio/mfx_lib/vpp/src/mfx_vpp_hw.cpp b/_studio/mfx_lib/vpp/src/mfx_vpp_hw.cpp
index 09b42e902ef9..2f15abaa2ac2 100644
--- a/_studio/mfx_lib/vpp/src/mfx_vpp_hw.cpp
+++ b/_studio/mfx_lib/vpp/src/mfx_vpp_hw.cpp
@@ -2440,6 +2440,7 @@ mfxStatus  VideoVPPHW::Init(
             case MFX_HW_RKL:
             case MFX_HW_ADL_S:
             case MFX_HW_ADL_P:
+            case MFX_HW_ADL_N:
             case MFX_HW_RPL_S:
                 res = m_pCmDevice->LoadProgram((void*)genx_fcopy_gen12lp,sizeof(genx_fcopy_gen12lp),m_pCmProgram,"nojitter");
                 break;
@@ -2471,7 +2472,7 @@ mfxStatus  VideoVPPHW::Init(
         CmDevice* pCmDevice = QueryCoreInterface<CmDevice>(m_pCore, MFXICORECM_GUID);
 
         sts = m_SCD.Init(par->vpp.In.CropW, par->vpp.In.CropH, par->vpp.In.Width, par->vpp.In.PicStruct, pCmDevice,
-        m_pCore->GetHWType() <= MFX_HW_ADL_P
+        m_pCore->GetHWType() <= MFX_HW_ADL_P || m_pCore->GetHWType() == MFX_HW_ADL_N
         );
         MFX_CHECK_STS(sts);
 
diff --git a/_studio/shared/asc/src/asc.cpp b/_studio/shared/asc/src/asc.cpp
index c5022eac4078..45289cc41ea2 100644
--- a/_studio/shared/asc/src/asc.cpp
+++ b/_studio/shared/asc/src/asc.cpp
@@ -308,6 +308,7 @@ mfxStatus ASC::InitGPUsurf(CmDevice* pCmDevice) {
     case PLATFORM_INTEL_TGLLP:
     case PLATFORM_INTEL_RKL:
     case PLATFORM_INTEL_DG1:
+    case PLATFORM_INTEL_ADL_N:
         res = m_device->LoadProgram((void *)genx_scd_gen12lp, sizeof(genx_scd_gen12lp), m_program, "nojitter");
         break;
     default:
diff --git a/_studio/shared/include/mfxstructures-int.h b/_studio/shared/include/mfxstructures-int.h
index 04284317a368..ffc7ca994713 100644
--- a/_studio/shared/include/mfxstructures-int.h
+++ b/_studio/shared/include/mfxstructures-int.h
@@ -79,6 +79,7 @@ enum eMFXHWType
     MFX_HW_DG1       = MFX_HW_TGL_LP + 3,
     MFX_HW_ADL_S     = MFX_HW_TGL_LP + 4,
     MFX_HW_ADL_P     = MFX_HW_TGL_LP + 5,
+    MFX_HW_ADL_N     = MFX_HW_TGL_LP + 9,
     MFX_HW_RPL_S     = MFX_HW_TGL_LP + 6,
     MFX_HW_DG2       = MFX_HW_TGL_LP + 7,
 
@@ -350,6 +351,10 @@ typedef struct {
     { 0x9be6, MFX_HW_CFL, MFX_GT2 },
     { 0x9bf6, MFX_HW_CFL, MFX_GT2 },
 
+    /* ADL-N */
+    { 0x46D0, MFX_HW_ADL_P, MFX_GT2 },//ADL-P
+    { 0x46D1, MFX_HW_ADL_P, MFX_GT2 },//ADL-P
+    { 0x46D2, MFX_HW_ADL_P, MFX_GT2 },//ADL-P
 
     /* CNL */
     { 0x5A51, MFX_HW_CNL, MFX_GT2 },
diff --git a/_studio/shared/src/cm_mem_copy.cpp b/_studio/shared/src/cm_mem_copy.cpp
index ca69a16c6949..1269bd6da715 100644
--- a/_studio/shared/src/cm_mem_copy.cpp
+++ b/_studio/shared/src/cm_mem_copy.cpp
@@ -2498,6 +2498,7 @@ mfxStatus CmCopyWrapper::InitializeSwapKernels(eMFXHWType hwtype)
     case MFX_HW_RKL:
     case MFX_HW_ADL_S:
     case MFX_HW_ADL_P:
+    case MFX_HW_ADL_N:
     case MFX_HW_RPL_S:
         cmSts = m_pCmDevice->LoadProgram((void*)genx_copy_kernel_gen12lp,sizeof(genx_copy_kernel_gen12lp),m_pCmProgram,"nojitter");
         break;
diff --git a/api/vpl/mfxcommon.h b/api/vpl/mfxcommon.h
index 69619b39744d..db10f6b74ebb 100644
--- a/api/vpl/mfxcommon.h
+++ b/api/vpl/mfxcommon.h
@@ -202,6 +202,7 @@ enum {
     MFX_PLATFORM_DG2            = 46, /*!< Code name DG2. */
     MFX_PLATFORM_ATS_M          = 46, /*!< Code name ATS-M, same media functionality as DG2. */
     MFX_PLATFORM_RAPTORLAKE_S   = 46, /*!< Code name Raptor Lake. */
+    MFX_PLATFORM_ALDERLAKE_N    = 55, /*!< Code name Alder Lake N. */
     MFX_PLATFORM_KEEMBAY        = 50, /*!< Code name Keem Bay. */
 };
 
-- 
2.34.1

