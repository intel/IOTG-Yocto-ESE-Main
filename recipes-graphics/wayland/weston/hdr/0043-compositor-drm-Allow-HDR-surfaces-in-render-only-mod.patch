From b4fb5d4e5fa2c6e0b0cc99713346d40dd08c87e4 Mon Sep 17 00:00:00 2001
From: Shashank Sharma <shashank.sharma@intel.com>
Date: Mon, 22 Apr 2019 15:22:50 +0530
Subject: [PATCH 43/45] compositor-drm: Allow HDR surfaces in render-only mode
 only

As the display sw stack doesn't have support to handle tone-mapping
and color corrections for HDR surfaces, do not allow HDR view composition
in plane-only/mixed mode, force it in render-only composition mode.

Signed-off-by: Shashank Sharma <shashank.sharma@intel.com>
---
 libweston/compositor-drm.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/libweston/compositor-drm.c b/libweston/compositor-drm.c
index d79c3cba..b4eb8289 100644
--- a/libweston/compositor-drm.c
+++ b/libweston/compositor-drm.c
@@ -4284,7 +4284,7 @@ drm_assign_planes(struct weston_output *output_base, void *repaint_data)
 		}
 	}
 
-	if (!b->sprites_are_broken && !output->virtual) {
+	if (!b->sprites_are_broken && !output->virtual && !hdr_surface) {
 		drm_debug(b, "\t[repaint] trying planes-only build state\n");
 		state = drm_output_propose_state(output_base, pending_state, mode);
 		if (!state) {
-- 
2.21.0

