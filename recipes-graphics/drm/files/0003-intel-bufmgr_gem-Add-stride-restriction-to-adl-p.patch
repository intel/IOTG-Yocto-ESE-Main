From b4949445feb3fabb081de858b2cdeca3fb7ed98c Mon Sep 17 00:00:00 2001
From: Tejas Upadhyay <tejaskumarx.surendrakumar.upadhyay@intel.com>
Date: Mon, 17 May 2021 15:49:44 +0530
Subject: [PATCH 3/3] intel/bufmgr_gem: Add stride restriction to adl-p
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

ADL_P have stride restrictions that requires stride be power of two
for non-linear buffers.

Signed-off-by: Clinton Taylor <Clinton.A.Taylor@intel.com>
Signed-off-by: Jos√© Roberto de Souza <jose.souza@intel.com>
Signed-off-by: Tejas Upadhyay <tejaskumarx.surendrakumar.upadhyay@intel.com>
---
 intel/intel_bufmgr_gem.c | 13 +++++++++++++
 1 file changed, 13 insertions(+)

diff --git a/intel/intel_bufmgr_gem.c b/intel/intel_bufmgr_gem.c
index 3c522ea..8a68bf4 100644
--- a/intel/intel_bufmgr_gem.c
+++ b/intel/intel_bufmgr_gem.c
@@ -96,6 +96,12 @@
  */
 #define lower_32_bits(n) ((__u32)(n))
 
+#define _fls(x) ((x) ? __builtin_choose_expr(sizeof(x) == 8, \
+					    64 - __builtin_clzll(x), \
+					    32 - __builtin_clz(x)) : 0)
+
+#define roundup_power_of_two(x) ((x) != 0 ? 1 << _fls((x) - 1) : 0)
+
 typedef struct _drm_intel_bo_gem drm_intel_bo_gem;
 
 struct drm_intel_gem_bo_bucket {
@@ -147,6 +153,7 @@ typedef struct _drm_intel_bufmgr_gem {
 	unsigned int has_vebox : 1;
 	unsigned int has_exec_async : 1;
 	bool fenced_relocs;
+	bool tiled_bo_req_stride_pow2;
 
 	struct {
 		void *ptr;
@@ -366,6 +373,9 @@ drm_intel_gem_bo_tile_pitch(drm_intel_bufmgr_gem *bufmgr_gem,
 	if (*tiling_mode == I915_TILING_NONE)
 		return ALIGN(pitch, 64);
 
+	if (bufmgr_gem->tiled_bo_req_stride_pow2)
+		return roundup_power_of_two(pitch);
+
 	if (*tiling_mode == I915_TILING_X
 			|| (IS_915(bufmgr_gem->pci_device)
 			    && *tiling_mode == I915_TILING_Y))
@@ -3760,6 +3770,9 @@ drm_intel_bufmgr_gem_init(int fd, int batch_size)
 		goto exit;
 	}
 
+	if (intel_is_adlp(bufmgr_gem->pci_device))
+		bufmgr_gem->tiled_bo_req_stride_pow2 = true;
+
 	if (IS_GEN3(bufmgr_gem->pci_device) &&
 	    bufmgr_gem->gtt_size > 256*1024*1024) {
 		/* The unmappable part of gtt on gen 3 (i.e. above 256MB) can't
-- 
2.7.4

